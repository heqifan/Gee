# 迭代图像集

尽管map()对集合中的每个图像都应用了一个函数，但该函数会独立访问集合中的每个图像。例如，假设您想从时间序列中计算时间t的累积异常(At)。要获得递归定义的形式为At = f(Imaget, At-1)的序列，映射将不起作用，因为函数(f)依赖于前面的结果(At-1)。例如，假设您想要计算一系列相对于基线的累积归一化植被指数(NDVI)异常图像。设A0 = 0, f(Imaget, At-1) = Imaget + At-1，其中At-1是cu



```javascript
// 加载MODIS EVI图像。
var collection = ee.ImageCollection('MODIS/006/MYD13A1').select('EVI')

//从前10年的数据定义参考条件。
var reference = collection.filterDate('2001-01-01', '2010-12-31')
  // 按时间顺序降序排序。
  .sort('system:time_start', false)

// 计算前10年的平均值。
var mean = reference.mean()

// 每幅图像减去2001-2010年的平均值来计算异常值收集2011-2014年的图像。将日期元数据复制到计算新集合中的异常图像。
var series = collection.filterDate('2011-01-01', '2014-12-31').map(function(image) {
    return image.subtract(mean).set('system:time_start', image.get('system:time_start'))
})

// 显示累计异常。
Map.setCenter(-100.811, 40.2, 5);
Map.addLayer(series.sum(),
    {min: -60000, max: 60000, palette: ['FF0000', '000000', '00FF00']}, 'EVI anomaly');

// 从引用集合中最近的映像获取时间戳。
var time0 = reference.first().get('system:time_start');

// 使用imageCollection.iterate()生成一个随时间累积的异常集合。
// iterate()的初始值是一个已经处理过的异常图像列表。
// 列表中的第一个异常映像仅为0，时间戳为time0。
var first = ee.List([
  // 将第一支乐队更名为“EVI”。
  ee.Image(0).set('system:time_start', time0).select([0], ['EVI'])
]);

// 这是一个传递给Iterate()的函数。
// 当计算出异常图像时，将它们添加到列表中。
var accumulate = function(image, list) {
  // Get the latest cumulative anomaly image from the end of the list with
  // get(-1).  Since the type of the list argument to the function is unknown,
  // it needs to be cast to a List.  Since the return type of get() is unknown,
  // cast it to Image.
  var previous = ee.Image(ee.List(list).get(-1));
  // Add the current anomaly to make a new cumulative anomaly image.
  var added = image.add(previous)
    // Propagate metadata to the new image.
    .set('system:time_start', image.get('system:time_start'));
  // Return the list with the cumulative anomaly inserted.
  return ee.List(list).add(added);
};

// Create an ImageCollection of cumulative anomaly images by iterating.
// Since the return type of iterate is unknown, it needs to be cast to a List.
var cumulative = ee.ImageCollection(ee.List(series.iterate(accumulate, first)));

// Predefine the chart titles.
var title = {
  title: 'Cumulative EVI anomaly over time',
  hAxis: {title: 'Time'},
  vAxis: {title: 'Cumulative EVI anomaly'},
};

// Chart some interesting locations.
var pt1 = ee.Geometry.Point(-65.544, -4.894);
print('Amazon rainforest:',
    Chart.image.series(cumulative, pt1, ee.Reducer.first(), 500).setOptions(title));

var pt2 = ee.Geometry.Point(116.4647, 40.1054);
print('Beijing urbanization:',
    Chart.image.series(cumulative, pt2, ee.Reducer.first(), 500).setOptions(title));

var pt3 = ee.Geometry.Point(-110.3412, 34.1982);
print('Arizona forest disturbance and recovery:',
    Chart.image.series(cumulative, pt3, ee.Reducer.first(), 500).setOptions(title));
```



绘制这些序列图可以表明NDVI相对于以前的扰动是否处于稳定状态，或者NDVI是否趋向于新的状态。从图表部分了解更多关于地球引擎的图表。

迭代函数只能执行有限的操作。具体来说，它不能修改函数之外的变量;它不能打印任何东西;它不能使用JavaScript的' if '或' for '语句。您希望收集的任何结果或希望传递到下一次迭代的中间信息都必须在函数的返回值中。你可以使用' ee.Algorithms.If() '来执行。